---
# Namespace for the PanFS Realm Credentials Secret
apiVersion: v1
kind: Namespace
metadata:
  name: csi-panfs-storage-class
---
# Copyright 2025 VDURA Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# Secret for the PanFS Storage Class (Realm Address, Username, Password, Private Key, and Passphrase)
apiVersion: v1
kind: Secret
metadata:
  name: csi-panfs-storage-class
  namespace: csi-panfs-storage-class
type: Opaque
stringData:
  # Realm address, username, password, and/or private key for the PanFS backend
  # These values are used by the CSI driver to connect to the PanFS backend

  # PanFS Realm Endpoint (IP Address or DNS Name)
  realm_ip: panfs-realm.example.com

  # PanFS Realm username, its password, private key, and private key passphrase (if configured)
  user: <REALM_USERNAME>

  # Leave empty if not using password
  password: "<REALM_PASSWORD>"

  # Leave empty if not using private key
  private_key: 

  # Leave empty if not not using private key passphrase
  private_key_passphrase: 
---
# Copyright 2025 VDURA Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Storage Class for PanFS CSI
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: csi-panfs-storage-class
  annotations:
    # Set this to true to mark this StorageClass as the default
    # This allows Kubernetes to use this StorageClass automatically for PVCs that do not specify a StorageClass
    storageclass.kubernetes.io/is-default-class: "false"

provisioner: com.vdura.csi.panfs
allowVolumeExpansion: true

# Possible values for volumeBindingMode:
# - Immediate: The volume is bound immediately when the PVC is created
# - WaitForFirstConsumer: The volume is not bound until a pod that uses the PVC is scheduled
volumeBindingMode: WaitForFirstConsumer

# Possible values for reclaimPolicy:
# - Delete: Automatically delete the volume when the PVC is deleted
# - Retain: Keep the volume after the PVC is deleted, allowing manual cleanup
reclaimPolicy: Delete

parameters:
  # Relates to Secret object that contains credentials for the CSI driver
  # This secret is used by the CSI driver to authenticate with the PanFS backend
  csi.storage.k8s.io/provisioner-secret-name: &secretName csi-panfs-storage-class
  csi.storage.k8s.io/provisioner-secret-namespace: &secretNamespace csi-panfs-storage-class
  csi.storage.k8s.io/node-publish-secret-name: *secretName
  csi.storage.k8s.io/node-publish-secret-namespace: *secretNamespace
  csi.storage.k8s.io/controller-expand-secret-name: *secretName
  csi.storage.k8s.io/controller-expand-secret-namespace: *secretNamespace

  # Specific parameters for volumes (to be) created in the PanFS Realm
  panfs.csi.vdura.com/bladeset: "Set 1"
  panfs.csi.vdura.com/description: "PanFS CSI Storage Class"
  panfs.csi.vdura.com/efsa: "retry"
  panfs.csi.vdura.com/layout: "raid6+"
  panfs.csi.vdura.com/maxwidth: "3"
  panfs.csi.vdura.com/operm: "all"
  panfs.csi.vdura.com/recoverypriority: "50"
  panfs.csi.vdura.com/rgdepth: "2"
  panfs.csi.vdura.com/rgwidth: "3"
  panfs.csi.vdura.com/stripeunit: "64k"

# Optional mount options for the volumes created by this StorageClass
# These options are passed to the underlying filesystem when mounting the volume
mountOptions: []
---
# Copyright 2025 VDURA Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Role that defines permissions for the CSI driver to read secrets
# This role allows the PanFS CSI driver to access secrets containing
# storage credentials and configuration needed for volume operations
# NOTE: This is a namespace-scoped Role, so it only grants access to secrets
# in the current namespace (csi-panfs-storage-class), not cluster-wide
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: csi-panfs-controller-read-secret
  namespace: csi-panfs-storage-class
rules:
  # Allow access to secrets for CSI driver credentials
  # The CSI driver needs to read secrets that contain PanFS backend credentials
  # Permissions are limited to the current namespace only (not cluster-wide)
  - apiGroups: [""] 
    resources: ["secrets"]
    verbs: ["get", "list"]
---
# RoleBinding that connects the CSI driver service account to the secret-read role
# This binding grants the PanFS CSI controller service account the permissions
# defined in the role above, allowing it to read secrets in this namespace
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: csi-panfs-controller-read-secret-rolebinding
  namespace: csi-panfs-storage-class
subjects:
  # The service account used by the PanFS CSI driver controller
  # Relates to PanFS Driver ServiceAccount (controller) 
  - kind: ServiceAccount
    name: csi-panfs-controller    # The name of the PanFS CSI Driver service account
    namespace: csi-panfs          # The namespace where the PanFS CSI Driver is deployed
roleRef:
  # Reference to the Role defined above that grants secret read permissions
  kind: Role
  name: csi-panfs-controller-read-secret
  apiGroup: rbac.authorization.k8s.io
