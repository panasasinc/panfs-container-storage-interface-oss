# Copyright 2025 VDURA Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Role that defines permissions for the CSI driver to read secrets
# This role allows the PanFS CSI driver to access secrets containing
# storage credentials and configuration needed for volume operations
# NOTE: This is a namespace-scoped Role, so it only grants access to secrets
# in the current namespace ({{ .Release.Namespace }}), not cluster-wide
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: {{ .Values.csiPanFSDriver.controllerServiceAccount }}-read-secret
  namespace: {{ .Release.Namespace }}
rules:
  # Allow access to secrets for CSI driver credentials
  # The CSI driver needs to read secrets that contain PanFS backend credentials
  # Permissions are limited to the current namespace only (not cluster-wide)
  - apiGroups: [""] 
    resources: ["secrets"]
    verbs: ["get", "list"]
---
# RoleBinding that connects the CSI driver service account to the secret-read role
# This binding grants the PanFS CSI controller service account the permissions
# defined in the role above, allowing it to read secrets in this namespace
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: {{ .Values.csiPanFSDriver.controllerServiceAccount }}-read-secret-rolebinding
  namespace: {{ .Release.Namespace }}
subjects:
  # The service account used by the PanFS CSI driver controller
  # Relates to PanFS Driver ServiceAccount (controller) 
  - kind: ServiceAccount
    name: {{ .Values.csiPanFSDriver.controllerServiceAccount }}    # The name of the PanFS CSI Driver service account
    namespace: {{ .Values.csiPanFSDriver.namespace }}          # The namespace where the PanFS CSI Driver is deployed
roleRef:
  # Reference to the Role defined above that grants secret read permissions
  kind: Role
  name: {{ .Values.csiPanFSDriver.controllerServiceAccount }}-read-secret
  apiGroup: rbac.authorization.k8s.io